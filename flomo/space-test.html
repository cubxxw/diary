<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç©ºç™½ä¿®å¤æµ‹è¯• - flomoå¢å¼ºç‰ˆ</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
      margin: 0;
      padding: 0;
      background: #e8f5e8;
      overflow-x: hidden;
    }
    
    .test-header {
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      color: white;
      padding: 8px;
      text-align: center;
      font-size: 12px;
      font-weight: bold;
    }
    
    .metrics {
      background: white;
      padding: 8px;
      border-bottom: 2px solid #ddd;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      font-size: 11px;
    }
    
    .metric {
      text-align: center;
      padding: 4px;
      border-radius: 4px;
      border: 1px solid #eee;
    }
    
    .metric-title {
      font-weight: bold;
      color: #666;
      font-size: 10px;
    }
    
    .metric-value {
      font-size: 14px;
      font-weight: bold;
      margin-top: 2px;
    }
    
    .good { background: #e8f5e8; color: #2d5a2d; border-color: #90c695; }
    .warning { background: #fff3e0; color: #8b4513; border-color: #ffb74d; }
    .error { background: #ffebee; color: #c62828; border-color: #ef5350; }
    
    .iframe-wrapper {
      position: relative;
      height: calc(100vh - 120px);
      border: 2px solid #333;
      margin: 4px;
      border-radius: 4px;
      overflow: hidden;
    }
    
    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    .overlay {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 10px;
      z-index: 10;
    }
    
    .controls {
      background: #f8f9fa;
      padding: 6px;
      display: flex;
      justify-content: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 11px;
      cursor: pointer;
      min-width: 60px;
    }
    
    button:hover { background: #0056b3; }
    button.success { background: #28a745; }
    button.warning { background: #ffc107; color: #212529; }
    button.danger { background: #dc3545; }
  </style>
</head>
<body>
  <div class="test-header">
    ğŸ” ç©ºç™½æ£€æµ‹å™¨ - å®æ—¶ç›‘æ§iframeå¸ƒå±€é—®é¢˜
  </div>
  
  <div class="metrics">
    <div class="metric" id="window-metric">
      <div class="metric-title">çª—å£å¤§å°</div>
      <div class="metric-value" id="window-size">-</div>
    </div>
    
    <div class="metric" id="body-metric">
      <div class="metric-title">Bodyå®½åº¦</div>
      <div class="metric-value" id="body-width">-</div>
    </div>
    
    <div class="metric" id="iframe-metric">
      <div class="metric-title">iframeå®½åº¦</div>
      <div class="metric-value" id="iframe-width">-</div>
    </div>
    
    <div class="metric" id="overflow-metric">
      <div class="metric-title">æº¢å‡ºæ£€æµ‹</div>
      <div class="metric-value" id="overflow-status">-</div>
    </div>
    
    <div class="metric" id="ratio-metric">
      <div class="metric-title">å æ¯”</div>
      <div class="metric-value" id="usage-ratio">-</div>
    </div>
    
    <div class="metric" id="space-metric">
      <div class="metric-title">ç©ºç™½å¤§å°</div>
      <div class="metric-value" id="wasted-space">-</div>
    </div>
  </div>
  
  <div class="iframe-wrapper">
    <iframe id="test-iframe" src="./enhancer.html"></iframe>
    <div class="overlay">
      å®æ—¶ç›‘æ§ â€¢ <span id="status-indicator">ğŸŸ¢</span>
    </div>
  </div>
  
  <div class="controls">
    <button onclick="forceRefresh()">ğŸ”„ å¼ºåˆ¶åˆ·æ–°</button>
    <button onclick="callFixFunction()" class="success">ğŸ”§ è°ƒç”¨ä¿®å¤</button>
    <button onclick="simulateResize()" class="warning">ğŸ“ æ¨¡æ‹Ÿè°ƒæ•´</button>
    <button onclick="toggleDebug()" class="warning">ğŸ› è°ƒè¯•æ¨¡å¼</button>
    <button onclick="exportReport()" class="info">ğŸ“Š å¯¼å‡ºæŠ¥å‘Š</button>
  </div>

  <script>
    let debugMode = false;
    let updateInterval;
    
    function updateMetrics() {
      const windowWidth = window.innerWidth;
      const windowHeight = window.innerHeight;
      const bodyWidth = document.body.scrollWidth;
      const iframe = document.getElementById('test-iframe');
      const iframeWidth = iframe.offsetWidth;
      
      // æ›´æ–°æ˜¾ç¤º
      document.getElementById('window-size').textContent = `${windowWidth}Ã—${windowHeight}`;
      document.getElementById('body-width').textContent = `${bodyWidth}px`;
      document.getElementById('iframe-width').textContent = `${iframeWidth}px`;
      
      // è®¡ç®—æº¢å‡º
      const overflow = bodyWidth > windowWidth;
      const overflowAmount = Math.max(0, bodyWidth - windowWidth);
      document.getElementById('overflow-status').textContent = overflow ? `+${overflowAmount}px` : 'æ­£å¸¸';
      
      // è®¡ç®—ä½¿ç”¨ç‡
      const ratio = Math.round((iframeWidth / windowWidth) * 100);
      document.getElementById('usage-ratio').textContent = `${ratio}%`;
      
      // è®¡ç®—æµªè´¹çš„ç©ºé—´
      const wastedSpace = windowWidth - iframeWidth;
      document.getElementById('wasted-space').textContent = wastedSpace > 0 ? `${wastedSpace}px` : '0px';
      
      // æ›´æ–°æ ·å¼
      updateMetricStyles(windowWidth, bodyWidth, iframeWidth, ratio, wastedSpace);
      
      if (debugMode) {
        console.log('ğŸ“Š Metrics:', {
          windowWidth, bodyWidth, iframeWidth, overflow, ratio, wastedSpace
        });
      }
    }
    
    function updateMetricStyles(windowWidth, bodyWidth, iframeWidth, ratio, wastedSpace) {
      // Window metric
      const windowMetric = document.getElementById('window-metric');
      windowMetric.className = 'metric good';
      
      // Body width
      const bodyMetric = document.getElementById('body-metric');
      bodyMetric.className = bodyWidth <= windowWidth ? 'metric good' : 'metric error';
      
      // iframe width  
      const iframeMetric = document.getElementById('iframe-metric');
      iframeMetric.className = ratio >= 90 ? 'metric good' : ratio >= 70 ? 'metric warning' : 'metric error';
      
      // Overflow
      const overflowMetric = document.getElementById('overflow-metric');
      overflowMetric.className = bodyWidth <= windowWidth ? 'metric good' : 'metric error';
      
      // Ratio
      const ratioMetric = document.getElementById('ratio-metric');
      ratioMetric.className = ratio >= 90 ? 'metric good' : ratio >= 70 ? 'metric warning' : 'metric error';
      
      // Wasted space
      const spaceMetric = document.getElementById('space-metric');
      spaceMetric.className = wastedSpace < 20 ? 'metric good' : wastedSpace < 50 ? 'metric warning' : 'metric error';
      
      // Status indicator
      const indicator = document.getElementById('status-indicator');
      if (ratio >= 90 && bodyWidth <= windowWidth) {
        indicator.textContent = 'ğŸŸ¢'; // å®Œç¾
      } else if (ratio >= 70 && bodyWidth <= windowWidth + 10) {
        indicator.textContent = 'ğŸŸ¡'; // å¯æ¥å—
      } else {
        indicator.textContent = 'ğŸ”´'; // æœ‰é—®é¢˜
      }
    }
    
    function forceRefresh() {
      const iframe = document.getElementById('test-iframe');
      iframe.src = iframe.src;
    }
    
    function callFixFunction() {
      try {
        // å°è¯•è°ƒç”¨å„ç§ä¿®å¤å‡½æ•°
        if (window.fixRightSpace) window.fixRightSpace();
        if (window.emergencyHeightFix) window.emergencyHeightFix();
        if (window.fixHeightIssues) window.fixHeightIssues();
        
        // å°è¯•è°ƒç”¨iframeå†…çš„ä¿®å¤å‡½æ•°
        const iframe = document.getElementById('test-iframe');
        if (iframe.contentWindow) {
          if (iframe.contentWindow.fixRightSpace) iframe.contentWindow.fixRightSpace();
          if (iframe.contentWindow.emergencyHeightFix) iframe.contentWindow.emergencyHeightFix();
        }
        
        setTimeout(updateMetrics, 500);
      } catch (e) {
        console.error('ä¿®å¤å‡½æ•°è°ƒç”¨å¤±è´¥:', e);
      }
    }
    
    function simulateResize() {
      window.dispatchEvent(new Event('resize'));
      setTimeout(updateMetrics, 200);
    }
    
    function toggleDebug() {
      debugMode = !debugMode;
      console.log('Debug mode:', debugMode ? 'ON' : 'OFF');
    }
    
    function exportReport() {
      const metrics = {
        timestamp: new Date().toISOString(),
        windowSize: document.getElementById('window-size').textContent,
        bodyWidth: document.getElementById('body-width').textContent,
        iframeWidth: document.getElementById('iframe-width').textContent,
        overflowStatus: document.getElementById('overflow-status').textContent,
        usageRatio: document.getElementById('usage-ratio').textContent,
        wastedSpace: document.getElementById('wasted-space').textContent,
        userAgent: navigator.userAgent
      };
      
      console.log('ğŸ“Š Layout Report:', metrics);
      
      // å¤åˆ¶åˆ°å‰ªè´´æ¿
      navigator.clipboard.writeText(JSON.stringify(metrics, null, 2))
        .then(() => alert('æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿'))
        .catch(() => alert('æŠ¥å‘Šå·²è¾“å‡ºåˆ°æ§åˆ¶å°'));
    }
    
    // ç›‘å¬iframeåŠ è½½
    document.getElementById('test-iframe').addEventListener('load', function() {
      setTimeout(updateMetrics, 1000);
    });
    
    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', function() {
      setTimeout(updateMetrics, 100);
    });
    
    // å¼€å§‹å®šæœŸæ›´æ–°
    updateInterval = setInterval(updateMetrics, 1000);
    
    // åˆå§‹æ›´æ–°
    setTimeout(updateMetrics, 500);
    
    // é¡µé¢å¸è½½æ—¶æ¸…ç†
    window.addEventListener('beforeunload', function() {
      if (updateInterval) clearInterval(updateInterval);
    });
  </script>
</body>
</html>